<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="library.infrastructure.datasource.bookcollection.BookCollectionMapper">
    <select id="selectBookCollection" resultType="library.domain.model.bookcollection.BookCollection">
        SELECT
            蔵書.蔵書コード as "bookCollectionCode.value",
            蔵書.タイトル as "book.title.value",
            蔵書.著者 as "book.author.value",
            蔵書.本種別 as "book.bookType",
            CASE
               WHEN 蔵書の貸出.貸出ID IS NULL THEN '在庫中'
               ELSE '貸出中'
            END as "bookCollectionStatus"
        FROM
        (SELECT
            蔵書.蔵書コード,
            本.タイトル,
            本.著者,
            本.本種別
        FROM 蔵書
        INNER JOIN 本 on (蔵書.本ID = 本.本ID)
        WHERE 蔵書コード = #{bookCollectionCode.value}) as 蔵書
        LEFT OUTER JOIN
        (
         SELECT
            貸出.貸出ID,
            蔵書コード
         FROM 貸出
        LEFT OUTER JOIN 返却 ON (貸出.蔵書コード = #{bookCollectionCode.value} AND 貸出.貸出ID = 返却.貸出ID AND 返却.貸出ID = null)
        ) as 蔵書の貸出 ON 蔵書.蔵書コード = 蔵書の貸出.蔵書コード
    </select>
</mapper>